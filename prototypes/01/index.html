<!DOCTYPE html>
<style>
  .features {
    fill: none;
    stroke: #888;
    stroke-width: 0.3px;
  }
  select {
    float: right;
    margin-bottom: 20px;
  }
</style>
<body></body>
<script src="../vendor/d3.js"></script>
<script src="../vendor/topojson.js"></script>
<script src="../vendor/d3-scale-chromatic.js"></script>
<script>
  const width = 960
  const height = 960
  const defaultCategory = "prof_lq" // current selected category from dropdown element
  const categories = [
    {
      label: "makers",
      value: "make_lq"
    },
    {
      label: "services",
      value: "serv_lq"
    },
    {
      label: "professions",
      value: "prof_lq"
    },
    {
      label: "support",
      value: "supp_lq"
    }
  ]
  const dispatcher = d3.dispatch("change")


  function renderDropdown() {
    dropdown = d3.select("body")
      .append("select")

    const options = dropdown.selectAll("options")
      .data(categories)
      .enter()
      .append("option")
      .attr("value", d => d.value)
      .html(d => d.label)

    options.each(function(option) {
      const selection = d3.select(this)
      selection.datum(option)

      if (option.value === defaultCategory) {
        selection.attr("selected", true)
      }
    })

    dropdown.on("change", function() {
      const value = d3.select(this).property("value")
      dispatcher.call("change", this, value)
    })
  }


  function main (error, data) {
    if (error) throw error

    const geojson = topojson.feature(data, data.objects.tracts_2016_lq_4326)
    console.log(geojson, geojson.features[0].properties)

    const projection = d3.geoMercator()
      .fitSize([width, height], geojson)

    const path = d3.geoPath().projection(projection)

    const color = d3.scaleLinear()
      .range(d3.schemeRdYlBu[3].reverse())

    const zoomed = () => {
      group.attr(
        "transform",
        "translate("
          + d3.event.transform.x + ","
          + d3.event.transform.y +")scale("
          + d3.event.transform.k + ")"
      );
    }

    const zoom = d3.zoom()
      .scaleExtent([1, 20])
      .on("zoom", zoomed)

    const svg = d3.select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height)

    const group = svg
      .append("g")
      .classed("features", true)

    group.call(zoom)

    // render geojson paths
    function renderFeatures(category) {
      const features = group.selectAll("path")
        .data(geojson.features)

      features.enter()
        .append("path")
        .merge(features)
        .attr("d", path)
        .attr("fill", d => color(d.properties[category]))

      features.exit().remove()
    }

    // set domain of color scale using current category from dropdown
    function updateColorScaleDomain(category) {
      const extent = d3.extent(geojson.features, d => d.properties[category])
      color.domain([extent[0], 1, extent[1]])
    }

    // register events
    dispatcher.on("change.color", updateColorScaleDomain)
    dispatcher.on("change.features", renderFeatures)
    // call initial render
    dispatcher.call("change", this, defaultCategory)
  }

  renderDropdown()
  d3.json("../../data/census_tracts/tracts_2016_lq_4326/tracts_2016_lq_4326.json", main)
</script>
